\begin{code}
{-# OPTIONS --sized-types --without-K --postfix-projections #-}
module Generic.Simple.Semantics (Ty : Set) where

  open import Data.LTree
  open import Data.LTree.Vector
  open import Data.Product
  open import Function.Extra using ([_]_âŠ¨_)
  open import Level
  open import Size
  open import Relation.Nary

  open import Generic.Simple.Syntax Ty
  open import Generic.Simple.Syntax.Term Ty
  open import Generic.Simple.Environment Ty

  private
    variable
      sz : Size
\end{code}

%<*Kripke>
\begin{code}
  Kripke : (ğ“¥ ğ“’ : OpenFam) â†’ Ctx â†’ OpenFam
  Kripke ğ“¥ ğ“’ Î” Î“ A = â–¡ ([ ğ“¥ ]_â‡’áµ‰ Î” â‡’ [ ğ“’ ]_âŠ¨ A) Î“
\end{code}
%</Kripke>

\begin{code}
  mapKğ“’ : âˆ€ {ğ“’ ğ“’â€² A B} â†’ âˆ€[ [ ğ“’ ]_âŠ¨ A â‡’ [ ğ“’â€² ]_âŠ¨ B ] â†’
    (âˆ€ {ğ“¥ Î“ Î”} â†’ Kripke ğ“¥ ğ“’ Î” Î“ A â†’ Kripke ğ“¥ ğ“’â€² Î” Î“ B)
  mapKğ“’ f b r Ï = f (b r Ï)
\end{code}

%<*Semantics>
\begin{code}
  record Semantics (d : System) (ğ“¥ ğ“’ : OpenFam) : Set where
    infix 20 _ğ“¥âŠ¨_ _ğ“’âŠ¨_; private _ğ“¥âŠ¨_ = ğ“¥; _ğ“’âŠ¨_ = ğ“’
    field
      ren^ğ“¥ : âˆ€ {A} â†’ âˆ€[ _ğ“¥âŠ¨ A â‡’ â–¡ (_ğ“¥âŠ¨ A) ]
      âŸ¦varâŸ§ : âˆ€[ ğ“¥ â‡’ ğ“’ ]
      âŸ¦conâŸ§ : âˆ€[ âŸ¦ d âŸ§s (Kripke ğ“¥ ğ“’) â‡’ ğ“’ ]
\end{code}
%</Semantics>

\begin{code}
    bindEnv : âˆ€ {Î” Î”r} â†’
      âˆ€[ [ ğ“¥ ]_â‡’áµ‰ Î” â‡’ â–¡ ([ ğ“¥ ]_â‡’áµ‰ Î”r â‡’ [ ğ“¥ ]_â‡’áµ‰ (Î” ++á¶œ Î”r)) ]
    bindEnv Ï r Ïƒ (el (â†™ i) q) = ren^ğ“¥ (Ï (el i q)) r
    bindEnv Ï r Ïƒ (el (â†˜ i) q) = Ïƒ (el i q)
\end{code}

%<*sem>
\begin{code}
    sem : âˆ€ {Î“ Î”} â†’ [ ğ“¥ ] Î“ â‡’áµ‰ Î” â†’ âˆ€ {sz A} â†’
      [ d , sz ] Î” âŠ¢ A â†’ Î“ ğ“’âŠ¨ A
    body : âˆ€ {Î“ Î”} â†’ [ ğ“¥ ] Î“ â‡’áµ‰ Î” â†’ âˆ€ {sz Î˜ A} â†’
      Scope [ d , sz ]_âŠ¢_ Î˜ Î” A â†’ Kripke ğ“¥ ğ“’ Î˜ Î“ A

    sem Ï (`var v) = âŸ¦varâŸ§ (Ï v)
    sem Ï (`con M) = âŸ¦conâŸ§ (map-s d (body Ï) M)

    body Ï M r Ïƒ = sem (bindEnv Ï r Ïƒ) M
\end{code}
%</sem>
