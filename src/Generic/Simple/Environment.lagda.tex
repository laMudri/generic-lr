\begin{code}
{-# OPTIONS --safe --without-K --postfix-projections #-}
module Generic.Simple.Environment (Ty : Set) where

  open import Data.LTree
  open import Data.LTree.Vector
  open import Function.Base
  open import Level
  open import Relation.Binary.PropositionalEquality
  open import Relation.Unary

  open import Generic.Simple.Syntax Ty

  private
    variable
      â„“ : Level
      ğ“¥ : Scoped â„“
      T : Ctx â†’ Set â„“
      A : Ty
      Î“ Î” Î˜ : Ctx

  record Var (A : Ty) (Î“ : Ctx) : Set where
    constructor var
    field
      idx : Ptr (Î“ .shape)
      tyq : Î“ .ty-ctx idx â‰¡ A
  open Var public

  record _â”€Env (Î“ : Ctx) (ğ“¥ : Scoped â„“) (Î” : Ctx) : Set â„“ where
    constructor pack
    field lookup : âˆ€ {A} (v : Var A Î“) â†’ ğ“¥ A Î”
  open _â”€Env public

  leftáµ› : âˆ€ {s t A Î“} â†’ Var A (ctx (Î“ âˆ˜ â†™)) â†’ Var A (ctx {s <+> t} Î“)
  leftáµ› (var i q) = var (â†™ i) q
  rightáµ› : âˆ€ {s t A Î“} â†’ Var A (ctx (Î“ âˆ˜ â†˜)) â†’ Var A (ctx {s <+> t} Î“)
  rightáµ› (var i q) = var (â†˜ i) q

  Thinning : (Î“ Î” : Ctx) â†’ Set
  Thinning Î“ Î” = (Î“ â”€Env) Var Î”

  â–¡ : (Ctx â†’ Set â„“) â†’ (Ctx â†’ Set â„“)
  (â–¡ T) PÎ“ = âˆ€[ Thinning PÎ“ â‡’ T ]

  Thinnable : (Ctx â†’ Set â„“) â†’ Set â„“
  Thinnable T = âˆ€[ T â‡’ â–¡ T ]

  th^Var : Thinnable (Var A)
  th^Var v th = th .lookup v

  identity : Thinning Î“ Î“
  identity .lookup v = v

  select : Thinning Î“ Î” â†’ (Î” â”€Env) ğ“¥ Î˜ â†’ (Î“ â”€Env) ğ“¥ Î˜
  select th Ï .lookup v = Ï .lookup (th .lookup v)

  extract : âˆ€[ â–¡ T â‡’ T ]
  extract t = t identity

  duplicate : âˆ€[ â–¡ T â‡’ â–¡ (â–¡ T) ]
  duplicate t th ph = t (select th ph)

  th^â–¡ : Thinnable (â–¡ T)
  th^â–¡ = duplicate

  th^Env : (âˆ€ {A} â†’ Thinnable (ğ“¥ A)) â†’ Thinnable ((Î“ â”€Env) ğ“¥)
  th^Env th^ğ“¥ Ï th .lookup v = th^ğ“¥ (Ï .lookup v) th
\end{code}
