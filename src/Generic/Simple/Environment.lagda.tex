\begin{code}
{-# OPTIONS --safe --without-K --postfix-projections #-}
module Generic.Simple.Environment (Ty : Set) where

  open import Data.LTree
  open import Data.LTree.Vector
  open import Function.Base using (_âˆ˜_)
  open import Function.Extra using ([_]_âŠ¨_)
  open import Level
  open import Relation.Binary.PropositionalEquality
  open import Relation.Unary

  open import Generic.Simple.Syntax Ty

  private
    variable
      ğ“¥ : OpenFam
      T : Ctx â†’ Set
      A : Ty
      Î“ Î” Î˜ : Ctx

  infix 20 _âˆ‹_ _â‡’Ê³_

  record _âˆ‹_ (Î“ : Ctx) (A : Ty) : Set where
    constructor el
    field
      idx : Ptr (Î“ .shape)
      tyq : Î“ .ty-ctx idx â‰¡ A
  open _âˆ‹_ public

  [_]_â‡’áµ‰_ : OpenFam â†’ (Î“ Î” : Ctx) â†’ Set
  [ ğ“¥ ] Î“ â‡’áµ‰ Î” = âˆ€ {A} (v : Î” âˆ‹ A) â†’ ğ“¥ Î“ A

  -- record [_]_â‡’áµ‰_ (ğ“¥ : OpenFam) (Î“ Î” : Ctx) : Set where
  --   constructor pack
  --   field lookup : âˆ€ {A} (v : Î” âˆ‹ A) â†’ ğ“¥ Î“ A
  -- open [_]_â‡’áµ‰_ public

  leftáµ› : âˆ€ {s t A Î“} â†’ ctx (Î“ âˆ˜ â†™) âˆ‹ A â†’ ctx {s <+> t} Î“ âˆ‹ A
  leftáµ› (el i q) = el (â†™ i) q
  rightáµ› : âˆ€ {s t A Î“} â†’ ctx (Î“ âˆ˜ â†˜) âˆ‹ A â†’ ctx {s <+> t} Î“ âˆ‹ A
  rightáµ› (el i q) = el (â†˜ i) q

  _â‡’Ê³_ : (Î“ Î” : Ctx) â†’ Set
  _â‡’Ê³_ = [ _âˆ‹_ ]_â‡’áµ‰_

  â–¡ : (Ctx â†’ Set) â†’ (Ctx â†’ Set)
  (â–¡ T) Î“ = âˆ€[ (_â‡’Ê³ Î“) â‡’ T ]

  Renameable : (Ctx â†’ Set) â†’ Set
  Renameable T = âˆ€[ T â‡’ â–¡ T ]

  ren^Var : Renameable (_âˆ‹ A)
  ren^Var v th = th v

  identity : Î“ â‡’Ê³ Î“
  identity v = v

  select : Î“ â‡’Ê³ Î” â†’ [ ğ“¥ ] Î˜ â‡’áµ‰ Î“ â†’ [ ğ“¥ ] Î˜ â‡’áµ‰ Î”
  select th Ï v = Ï (th v)

  extract : âˆ€[ â–¡ T â‡’ T ]
  extract t = t identity

  duplicate : âˆ€[ â–¡ T â‡’ â–¡ (â–¡ T) ]
  duplicate t th ph = t (select {ğ“¥ = _âˆ‹_} th ph)

  ren^â–¡ : Renameable (â–¡ T)
  ren^â–¡ = duplicate

  ren^Env : (âˆ€ {A} â†’ Renameable ([ ğ“¥ ]_âŠ¨ A)) â†’ Renameable ([ ğ“¥ ]_â‡’áµ‰ Î“)
  ren^Env th^ğ“¥ Ï th v = th^ğ“¥ (Ï v) th
\end{code}
