\begin{code}
{-# OPTIONS --sized-types --without-K --postfix-projections --prop #-}

module Generic.Linear.Example.WRel where

  open import Algebra.Po
  open import Algebra.Relational
  open import Data.LTree
  open import Data.LTree.Vector
  open import Data.Product as Ã—
  open import Data.Unit using (âŠ¤; tt)
  open import Data.Wrap renaming ([_] to mk)
  open import Function.Base using (id; _âˆ˜_)
  open import Level
  open import Proposition
  open import Relation.Binary using (Rel)
  open import Relation.Binary.PropositionalEquality as â‰¡ using (_â‰¡_)
  open import Relation.Unary.Bunched.Properties
  open import Relation.Unary.Bunched.Synth
  open import Relation.Unary.Extra
  open import Relation.Nary
  open import Size

  module WithPoSemiring (poSemiring : PoSemiring 0â„“ 0â„“ 0â„“) where
    open PoSemiring poSemiring renaming (Carrier to Ann)

    infixr 9 _âˆ˜á´¿_

    record WRel {W : Set} (_â‰¤_ : Rel W 0â„“) : Setâ‚ where
      no-eta-equality
      field
        set : Set 0â„“
        rel : (a : set) â†’ W â†’ Set
        subres : âˆ€ {a w wâ€²} â†’ wâ€² â‰¤ w â†’ rel a w â†’ rel a wâ€²
    open WRel public

    record WRelMor {W â‰¤Ê·} (R S : WRel {W} â‰¤Ê·) : Set where
      constructor wRelMor
      field
        setâ‡’ : R .set â†’ S .set
        relâ‡’ : âˆ€[ (Iâ‹‚ _ \ x â†’ R .rel x â‡’ S .rel (setâ‡’ x)) ]
    open WRelMor public

    idá´¿ : âˆ€ {W â‰¤Ê·} {R : WRel {W} â‰¤Ê·} â†’ WRelMor R R
    idá´¿ .setâ‡’ = id
    idá´¿ .relâ‡’ = id

    _âˆ˜á´¿_ : âˆ€ {W â‰¤Ê·} {R S T : WRel {W} â‰¤Ê·} â†’
      WRelMor S T â†’ WRelMor R S â†’ WRelMor R T
    (g âˆ˜á´¿ f) .setâ‡’ = g .setâ‡’ âˆ˜ f .setâ‡’
    (g âˆ˜á´¿ f) .relâ‡’ = g .relâ‡’ âˆ˜ f .relâ‡’

    module WithWorlds
      (worlds : CommutativeRelMonoid 0â„“ 0â„“)
      where

      open CommutativeRelMonoid worlds public renaming
        (Carrier to W; _â‰¤_ to _â‰¤Ê·_; refl to â‰¤Ê·-refl)
      open BunchedOrder _â‰¤Ê·_ public
      open BunchedUnit _â‰¤Îµ public hiding (â„‘âŸ¨_âŸ©)
      open BunchedConjunction _â‰¤[_âˆ™_] public hiding (_âœ´âŸ¨_âŸ©_)
      open BunchedCommutativeMonoid worlds public

      Iá´¿ : WRel _â‰¤Ê·_
      Iá´¿ .set = âŠ¤
      Iá´¿ .rel _ = â„‘
      Iá´¿ .subres sub â„‘âŸ¨ sp âŸ© = â„‘âŸ¨ Îµ-mono sub sp âŸ©

      _âŠ—á´¿_ : (R S : WRel _â‰¤Ê·_) â†’ WRel _â‰¤Ê·_
      (R âŠ—á´¿ S) .set = R .set Ã— S .set
      (R âŠ—á´¿ S) .rel (a , b) = R .rel a âœ´ S .rel b
      (R âŠ—á´¿ S) .subres sub (r âœ´âŸ¨ sp âŸ© s) =
        r âœ´âŸ¨ âˆ™-mono sub â‰¤Ê·-refl â‰¤Ê·-refl sp âŸ© s

      _âŠ¸á´¿_ : (R S : WRel _â‰¤Ê·_) â†’ WRel _â‰¤Ê·_
      (R âŠ¸á´¿ S) .set = R .set â†’ S .set
      (R âŠ¸á´¿ S) .rel f = Iâ‹‚ _ \ x â†’ R .rel x â”€âœ´ S .rel (f x)
      (R âŠ¸á´¿ S) .subres sub rf .appâœ´ sp xx =
        rf .appâœ´ (âˆ™-mono â‰¤Ê·-refl sub â‰¤Ê·-refl sp) xx

      private
        variable
          R Râ€² S Sâ€² T Tâ€² : WRel _â‰¤Ê·_

      â—‡-alg : âˆ€ (R : WRel _â‰¤Ê·_) {x} â†’ âˆ€[ â—‡ (R .rel x) â‡’ R .rel x ]
      â—‡-alg R (â—‡âŸ¨ sub âŸ© r) = R .subres sub r

      map-âŠ—á´¿ : WRelMor R Râ€² â†’ WRelMor S Sâ€² â†’ WRelMor (R âŠ—á´¿ S) (Râ€² âŠ—á´¿ Sâ€²)
      map-âŠ—á´¿ f g .setâ‡’ = Ã—.map (f .setâ‡’) (g .setâ‡’)
      map-âŠ—á´¿ f g .relâ‡’ = map-âœ´ (f .relâ‡’ , g .relâ‡’)

      âŠ—á´¿-unitË¡â†’ : WRelMor (Iá´¿ âŠ—á´¿ R) R
      âŠ—á´¿-unitË¡â†’ .setâ‡’ = projâ‚‚
      âŠ—á´¿-unitË¡â†’ {R} .relâ‡’ = â—‡-alg R âˆ˜ 1-âœ´â†’
      âŠ—á´¿-unitÊ³â†’ : WRelMor (R âŠ—á´¿ Iá´¿) R
      âŠ—á´¿-unitÊ³â†’ .setâ‡’ = projâ‚
      âŠ—á´¿-unitÊ³â†’ {R} .relâ‡’ = â—‡-alg R âˆ˜ âœ´-1â†’
      âŠ—á´¿-unitÂ²â†’ : WRelMor (Iá´¿ âŠ—á´¿ Iá´¿) Iá´¿
      âŠ—á´¿-unitÂ²â†’ .setâ‡’ = _
      âŠ—á´¿-unitÂ²â†’ .relâ‡’ = 1âœ´1â†’

      âŠ—á´¿-unitË¡â† : WRelMor R (Iá´¿ âŠ—á´¿ R)
      âŠ—á´¿-unitË¡â† .setâ‡’ = tt ,_
      âŠ—á´¿-unitË¡â† .relâ‡’ = 1-âœ´â† âˆ˜ pure-â—‡
      âŠ—á´¿-unitÊ³â† : WRelMor R (R âŠ—á´¿ Iá´¿)
      âŠ—á´¿-unitÊ³â† .setâ‡’ = _, tt
      âŠ—á´¿-unitÊ³â† .relâ‡’ = âœ´-1â† âˆ˜ pure-â—‡
      âŠ—á´¿-unitÂ²â† : WRelMor Iá´¿ (Iá´¿ âŠ—á´¿ Iá´¿)
      âŠ—á´¿-unitÂ²â† .setâ‡’ = _
      âŠ—á´¿-unitÂ²â† .relâ‡’ = 1âœ´1â†

      âŠ—á´¿-inter : WRelMor ((R âŠ—á´¿ Râ€²) âŠ—á´¿ (S âŠ—á´¿ Sâ€²)) ((R âŠ—á´¿ S) âŠ—á´¿ (Râ€² âŠ—á´¿ Sâ€²))
      âŠ—á´¿-inter .setâ‡’ = uncurry (Ã—.zip _,_ _,_)
      âŠ—á´¿-inter .relâ‡’ = inter-âœ´

      curryá´¿ : WRelMor (R âŠ—á´¿ S) T â†’ WRelMor R (S âŠ¸á´¿ T)
      curryá´¿ f .setâ‡’ = curry (f .setâ‡’)
      curryá´¿ f .relâ‡’ r .appâœ´ sp s = f .relâ‡’ (r âœ´âŸ¨ sp âŸ© s)

      uncurryá´¿ : WRelMor R (S âŠ¸á´¿ T) â†’ WRelMor (R âŠ—á´¿ S) T
      uncurryá´¿ f .setâ‡’ = uncurry (f .setâ‡’)
      uncurryá´¿ f .relâ‡’ (r âœ´âŸ¨ sp âŸ© s) = f .relâ‡’ r .appâœ´ sp s

      record Bang : Setâ‚ where
        field
          !á´¿ : Ann â†’ WRel _â‰¤Ê·_ â†’ WRel _â‰¤Ê·_
          !á´¿-map : âˆ€ {r R S} â†’ WRelMor R S â†’ WRelMor (!á´¿ r R) (!á´¿ r S)
          !á´¿-0 : âˆ€ {r R} â†’ r â‰¤ 0# â†’ WRelMor (!á´¿ r R) Iá´¿
          !á´¿-+ : âˆ€ {r p q R} â†’ r â‰¤ p + q â†’ WRelMor (!á´¿ r R) (!á´¿ p R âŠ—á´¿ !á´¿ q R)
          !á´¿-1 : âˆ€ {r R} â†’ r â‰¤ 1# â†’ WRelMor (!á´¿ r R) R
          !á´¿-* : âˆ€ {r p q R} â†’ r â‰¤ p * q â†’ WRelMor (!á´¿ r R) (!á´¿ p (!á´¿ q R))
          !á´¿-I : âˆ€ {r} â†’ WRelMor Iá´¿ (!á´¿ r Iá´¿)
          !á´¿-âŠ— : âˆ€ {r R S} â†’ WRelMor (!á´¿ r R âŠ—á´¿ !á´¿ r S) (!á´¿ r (R âŠ—á´¿ S))

  module WithSyntax (poSemiring : PoSemiring 0â„“ 0â„“ 0â„“) (BaseTy : Set) where
    open PoSemiring poSemiring using () renaming (Carrier to Ann)

    infixr 5 _âŠ¸_

    data Ty : Set where
      base : BaseTy â†’ Ty
      _âŠ¸_ : (rA : Ann Ã— Ty) (B : Ty) â†’ Ty

    open import Generic.Linear.Everything Ty poSemiring hiding (Ann)

    data `AnnArr : Set where
      `lam `app : (rA : Ann Ã— Ty) (B : Ty) â†’ `AnnArr

    AnnArr : System
    AnnArr = `AnnArr â–¹ Î» where
      (`lam rA B) â†’ âŸ¨ [ rA ]á¶œ `âŠ¢ B âŸ© =â‡’ rA âŠ¸ B
      (`app rA@(r , A) B) â†’ âŸ¨ []á¶œ `âŠ¢ rA âŠ¸ B âŸ© `âœ´ r `Â· âŸ¨ []á¶œ `âŠ¢ A âŸ© =â‡’ B

    Term = [ AnnArr , âˆ ]_âŠ¢_

    open WithPoSemiring poSemiring

    module WithWRelSemantics
      (worlds : CommutativeRelMonoid 0â„“ 0â„“) (open WithWorlds worlds)
      (baseâŸ¦_âŸ§ : BaseTy â†’ WRel _â‰¤Ê·_) (bang : Bang)
      where

      open Bang bang public

      âŸ¦_âŸ§ : Ty â†’ WRel _â‰¤Ê·_
      âŸ¦ base Î± âŸ§ = baseâŸ¦ Î± âŸ§
      âŸ¦ (r , A) âŠ¸ B âŸ§ = !á´¿ r âŸ¦ A âŸ§ âŠ¸á´¿ âŸ¦ B âŸ§

      module âŸ¦_âŸ§á¶œ where
        go : âˆ€ {s} (P : Vector Ann s) (Î³ : Vector Ty s) â†’ WRel _â‰¤Ê·_
        go {[-]} P Î³ = !á´¿ (P here) âŸ¦ Î³ here âŸ§
        go {Îµ} P Î³ = Iá´¿
        go {s <+> t} P Î³ = go (P âˆ˜ â†™) (Î³ âˆ˜ â†™) âŠ—á´¿ go (P âˆ˜ â†˜) (Î³ âˆ˜ â†˜)
      âŸ¦_âŸ§á¶œ : Ctx â†’ WRel _â‰¤Ê·_
      âŸ¦ ctx P Î³ âŸ§á¶œ = âŸ¦_âŸ§á¶œ.go P Î³

      âŸ¦_âŠ¢_âŸ§ : OpenFam 0â„“
      âŸ¦ Î“ âŠ¢ A âŸ§ = WRelMor âŸ¦ Î“ âŸ§á¶œ âŸ¦ A âŸ§

      ctx-0 : âˆ€ {s R Î³} â†’ R â‰¤0* â†’ WRelMor âŸ¦ ctx {s} R Î³ âŸ§á¶œ Iá´¿
      ctx-0 {[-]} (mk sp0) = !á´¿-0 (sp0 here)
      ctx-0 {Îµ} _ = idá´¿
      ctx-0 {s <+> t} (mk sp0) =
        âŠ—á´¿-unitÂ²â†’ âˆ˜á´¿ map-âŠ—á´¿ (ctx-0 (mk (sp0 âˆ˜ â†™))) (ctx-0 (mk (sp0 âˆ˜ â†˜)))

      ctx-+ : âˆ€ {s R P Q Î³} â†’ R â‰¤[ P +* Q ] â†’
        WRelMor âŸ¦ ctx {s} R Î³ âŸ§á¶œ (âŸ¦ ctx P Î³ âŸ§á¶œ âŠ—á´¿ âŸ¦ ctx Q Î³ âŸ§á¶œ)
      ctx-+ {[-]} (mk sp+) = !á´¿-+ (sp+ here)
      ctx-+ {Îµ} _ = âŠ—á´¿-unitÂ²â†
      ctx-+ {s <+> t} (mk sp+) =
        âŠ—á´¿-inter âˆ˜á´¿ map-âŠ—á´¿ (ctx-+ (mk (sp+ âˆ˜ â†™))) (ctx-+ (mk (sp+ âˆ˜ â†˜)))

      ctx-* : âˆ€ {s R r P Î³} â†’ R â‰¤[ r *â‚— P ] â†’
        WRelMor âŸ¦ ctx {s} R Î³ âŸ§á¶œ (!á´¿ r âŸ¦ ctx P Î³ âŸ§á¶œ)
      ctx-* {[-]} (mk sp*) = !á´¿-* (sp* here)
      ctx-* {Îµ} _ = !á´¿-I
      ctx-* {s <+> t} (mk sp*) =
        !á´¿-âŠ— âˆ˜á´¿ map-âŠ—á´¿ (ctx-* (mk (sp* âˆ˜ â†™))) (ctx-* (mk (sp* âˆ˜ â†˜)))

      lookupá´¿ : âˆ€ {Î“ A} â†’ Î“ âˆ‹ A â†’ âŸ¦ Î“ âŠ¢ A âŸ§
      lookupá´¿ (lvar i q b) = go i q b
        where
        go : âˆ€ {s P Î³ A} (i : Ptr s) â†’ Î³ i â‰¡ A â†’ P â‰¤* âŸ¨ i âˆ£ â†’ âŸ¦ ctx P Î³ âŠ¢ A âŸ§
        go here â‰¡.refl b = !á´¿-1 (b .get here)
        go (â†™ i) q b =
          let bâ€² , br = un++â‚™ b; sp0 = â‰¤*â†’0* br in
          âŠ—á´¿-unitÊ³â†’ âˆ˜á´¿ map-âŠ—á´¿ (go i q bâ€²) (ctx-0 sp0)
        go (â†˜ i) q b =
          let bl , bâ€² = un++â‚™ b; sp0 = â‰¤*â†’0* bl in
          âŠ—á´¿-unitË¡â†’ âˆ˜á´¿ map-âŠ—á´¿ (ctx-0 sp0) (go i q bâ€²)

      open Semantics

      wrel : Semantics AnnArr _âˆ‹_ âŸ¦_âŠ¢_âŸ§
      wrel .ren^ğ“¥ = ren^âˆ‹
      wrel .âŸ¦varâŸ§ = lookupá´¿
      wrel .âŸ¦conâŸ§ (`lam (r , A) B , â‰¡.refl , m) = curryá´¿ (reify m)
      wrel .âŸ¦conâŸ§ {ctx R Î³}
        (`app (r , A) B , â‰¡.refl , _âœ´âŸ¨_âŸ©_ {P} {rQ} m sp+ (âŸ¨_âŸ©Â·_ {Q} sp* n)) =
        let nâ€² : WRelMor âŸ¦ ctx Q Î³ âŸ§á¶œ âŸ¦ A âŸ§
            nâ€² = reify n âˆ˜á´¿ âŠ—á´¿-unitÊ³â†
            mâ€² : WRelMor (âŸ¦ ctx P Î³ âŸ§á¶œ âŠ—á´¿ !á´¿ r âŸ¦ A âŸ§) âŸ¦ B âŸ§
            mâ€² = uncurryá´¿ (reify m âˆ˜á´¿ âŠ—á´¿-unitÊ³â†)
        in
        mâ€² âˆ˜á´¿ map-âŠ—á´¿ idá´¿ (!á´¿-map nâ€² âˆ˜á´¿ ctx-* sp*) âˆ˜á´¿ ctx-+ sp+
\end{code}
